# Деплой на сервер

Сборка и запуск в режиме **production**: один порт для приложения (фронт + API через nginx), порты настраиваются через `.env`, чтобы не конфликтовать с уже занятыми на сервере.

## 1. Подготовка на сервере

- Установите Docker и Docker Compose.
- Склонируйте репозиторий в каталог на сервере (или скопируйте файлы).

## 2. Настройка портов и секретов

В каталоге `infrastructure` создайте `.env` из примера:

```bash
cd infrastructure
cp .env.example .env
```

Отредактируйте `.env`:

| Переменная | Описание | Пример |
|------------|----------|--------|
| `HTTP_PORT` | Порт, на котором будет доступно приложение (сайт + API) | `8080`, `3000`, `80` |
| `POSTGRES_PORT` | Порт PostgreSQL на хосте (если нужен доступ снаружи) | `5432` или другой свободный |
| `JWT_SECRET` | Секрет для JWT (обязательно смените) | длинная случайная строка |
| `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB` | Учётные данные БД | по желанию |

Пример, если 80 и 5432 заняты:

```env
HTTP_PORT=8080
POSTGRES_PORT=5433
JWT_SECRET=ваш-длинный-секретный-ключ
```

## 3. Запуск

```bash
cd infrastructure
docker compose -f docker-compose.prod.yml --env-file .env up -d --build
```

Приложение будет доступно по адресу: `http://IP_СЕРВЕРА:HTTP_PORT` (например `http://192.168.1.10:8080`).

## 4. Обновление после изменений в коде

```bash
cd infrastructure
docker compose -f docker-compose.prod.yml --env-file .env up -d --build
```

## 5. Остановка

```bash
docker compose -f docker-compose.prod.yml down
```

Данные PostgreSQL сохраняются в Docker-томе `postgres_data`.

## 6. Деплой в aaPanel

**Отдельный nginx в контейнере не конфликтует с aaPanel.** Наш nginx слушает только тот порт, который вы задаёте в `HTTP_PORT` (например 8080), и не трогает 80/443 — они остаются за панелью и вашими сайтами.

1. **Порты в `.env`:**
   - `HTTP_PORT=8080` (или другой свободный порт, не 80).
   - `POSTGRES_PORT=5433` — если 5432 уже занят (например, другим проектом в Docker).

2. **Запуск** — через терминал aaPanel или SSH:
   ```bash
   cd /path/to/chat/infrastructure
   docker compose -f docker-compose.prod.yml --env-file .env up -d --build
   ```

3. **Доступ по домену и HTTPS:** в aaPanel создайте сайт (или выберите существующий) → **Обратный прокси** → укажите цель `http://127.0.0.1:8080` (или ваш `HTTP_PORT`). Панель сама настроит свой nginx на 80/443 и будет проксировать запросы в контейнер. SSL включается в настройках сайта в aaPanel.

4. **Загрузка файлов с мобилки:** по умолчанию nginx в aaPanel обрывает долгие запросы (~60 с). Если отправка фото/скринов с телефона падает с «Проверьте соединение», увеличьте таймауты обратного прокси:
   - В aaPanel: **Сайты** → ваш сайт (drun.kiriapp.ru) → **Обратный прокси** → **Редактировать** (или настройки прокси).
   - В конфиг прокси для этого сайта добавьте внутри блока `location`:
   ```nginx
   client_max_body_size 100m;
   proxy_connect_timeout 300s;
   proxy_send_timeout 300s;
   proxy_read_timeout 300s;
   ```
   Либо в панели, если есть поля «Таймаут отправки» / «Таймаут чтения», поставьте 300 секунд. После правок перезагрузите nginx в aaPanel.

Итого: один веб-сервер на 80/443 (aaPanel), приложение в Docker на своём порту, без конфликтов.

## 7. HTTPS (без aaPanel)

Если нужен HTTPS и панели нет, перед контейнерами ставьте обратный прокси (nginx, Caddy, Traefik) на 80/443: он принимает HTTPS и проксирует на `localhost:HTTP_PORT`. Настройка SSL — в документации выбранного прокси.
